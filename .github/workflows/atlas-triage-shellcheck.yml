name: ATLAS Triage (ShellCheck)

on:
  workflow_run:
    workflows: ["ShellCheck"]
    types: [completed]

permissions:
  actions: read
  contents: read
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Open/update issue on failure OR close on recovery
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const title = "[ATLAS] ShellCheck failing";
            const labels = ["atlas", "triage", "shellcheck"];

            const run = context.payload.workflow_run;
            const conclusion = run?.conclusion || "unknown";
            const runUrl = run?.html_url || `https://github.com/${owner}/${repo}/actions`;
            const sha = run?.head_sha || "unknown";
            const when = new Date().toISOString();

            const failBody =
`ATLAS detected a ShellCheck failure.

- Time: ${when}
- SHA: ${sha}
- Run: ${runUrl}
`;

            const okBody =
`ATLAS reports ShellCheck recovery âœ…

- Time: ${when}
- SHA: ${sha}
- Run: ${runUrl}
`;

            const { data: issues } = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue is:open in:title "${title}"`
            });

            if (conclusion === "failure") {
              if (issues.items.length > 0) {
                const issue_number = issues.items[0].number;
                await github.rest.issues.createComment({ owner, repo, issue_number, body: failBody });
                core.info(`Updated existing issue #${issue_number}`);
              } else {
                const created = await github.rest.issues.create({ owner, repo, title, body: failBody, labels });
                core.info(`Created issue #${created.data.number}`);
              }
            } else if (conclusion === "success") {
              if (issues.items.length > 0) {
                const issue_number = issues.items[0].number;
                await github.rest.issues.createComment({ owner, repo, issue_number, body: okBody });
                await github.rest.issues.update({ owner, repo, issue_number, state: "closed" });
                core.info(`Closed issue #${issue_number} on recovery`);
              } else {
                core.info("No open ShellCheck issue to close.");
              }
            } else {
              core.info(`Conclusion=${conclusion}; no action.`);
