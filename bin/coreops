#!/data/data/com.termux/files/usr/bin/bash
set -euo pipefail

COREOPS_HOME="${COREOPS_HOME:-$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)}"

# libs (optional)
source "$COREOPS_HOME/lib/common.sh" 2>/dev/null || true
source "$COREOPS_HOME/lib/log.sh" 2>/dev/null || true

cmd="${1:-help}"
shift || true

die() {
  echo "[ERROR] $*" >&2
  exit 1
}

run_module() {
  local name="$1"; shift || true
  local path="$COREOPS_HOME/modules/${name}.sh"
  [ -f "$path" ] || die "Missing module: ${name} (${path})"
  bash "$path" "$@"
}

case "$cmd" in
  help|-h|--help)
    cat <<'USAGE'
CoreOps Starter Kit

Usage:
  coreops help
  coreops deps
  coreops doctor
  coreops netcheck
  coreops sslcheck <host> [port]
  coreops portscan <host> <port>
  coreops audit <host>
  coreops scan <host>
  coreops live <host> [interval_seconds]
  coreops snapshot
USAGE
    ;;
  deps)     run_module "deps" "$@" ;;
  doctor)   run_module "doctor" "$@" ;;
  netcheck) run_module "netcheck" "$@" ;;
  sslcheck) run_module "sslcheck" "$@" ;;
  portscan) run_module "portscan" "$@" ;;
  audit)    run_module "audit" "$@" ;;
  scan)     run_module "scan" "$@" ;;
  live)     run_module "live" "$@" ;;
  snapshot) run_module "snapshot" "$@" ;;
  *)
    echo "[ERROR] Unknown command: $cmd" >&2
    echo "Try: coreops help" >&2
    exit 1
    ;;
esac
